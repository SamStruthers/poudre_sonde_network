---
title: "rist_for_jared"
author: "Sam Struthers"
date: "`r Sys.Date()`"
output: html_document
---

## sourcing and packages 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(lubridate)
library(ggplot2)
library(plotly)


try(plyr::ldply(list.files(path="src/",
                           pattern="*.R",
                           full.names=TRUE),
                source))

```



# Grab cleaned

```{r}

rist_cleaned <- feather::read_feather('data/pretty/all_data_15min.feather')%>%
  filter(site %in% c("rist", "legacy") )
```

## Grab Raw

```{r}

pre_2022 <- read_csv('data/pretty/all_sensor_data_pre2022.csv') %>%
  mutate(site = tolower(sensor)) %>%
  rename(pH1 = pH,
         comment_pre = comments) %>%
  select(-c(sensor, year, date, data))

field_notes <- readxl::read_excel('data/sensor_field_notes.xlsx') %>%
  mutate(DT = (paste0(date, " ", start_time_mst))) %>%
  mutate(DT = ymd_hm(DT)) %>%
  arrange(DT) %>%
  mutate(DT = round_date(DT, "15 minutes"))

cal_table <- cal_tabler()


rist_raw <- going_rawless(site_name = "rist", trolled = NA) %>%
  mutate(DT = ymd_hms(DT)) %>%
  # Dataset got swapped to Rist's sensor, so need to remove data that 
  # is actually Rist. Sensor also capped from 5/6/2022 - 5/9/2022 (flow too low)
  filter(ymd_hms(DT) <= ymd_hms("2022-05-30 09:00:00")) %>%
  filter(!(ymd_hms(DT) >= ymd_hms('2022-05-06 12:00:00') & ymd_hms(DT) <= ymd_hms('2022-05-09 14:30:00'))) %>%
  padr::pad(by = 'DT') %>%
  # Link up calibration data:
  full_join(na.locf(na.locf(filter(cal_table, site == "rist")), fromLast = TRUE), 
            by = c('site','DT'))


```


## SC plot

```{r pressure, echo=FALSE}

SC <- ggplot()+
  geom_line(data = rist_cleaned,aes(x=DT , y= Specific_Conductivity_µS_cm, group = site, color = site))+
  theme_bw()

plotly::ggplotly(SC)


```


## Temp plot

```{r pressure, echo=FALSE}

temp <- ggplot()+
  geom_line(data = rist_cleaned,aes(x=DT , y= Temperature_C, group = site, color = site))+
  theme_bw()

plotly::ggplotly(temp)


```


## Depth plot

```{r pressure, echo=FALSE}

depth <- ggplot()+
  geom_line(data = rist_cleaned,aes(x=DT , y= Depth_ft, group = site, color = site))+
  theme_bw()

plotly::ggplotly(depth)


```
## Export Data

```{r}

rist_for_jared <- rist_cleaned%>%
  filter(site == "rist")%>%
  mutate(date = as_date(DT), 
         hour = lubridate::hour(DT), 
         minute = lubridate::minute(DT))%>%
  select(DT,date, hour, minute, site , Temperature_C, Specific_Conductivity_µS_cm, Depth_ft)

names(rist_for_jared)
unique(rist_for_jared$site)

arrow::write_csv_arrow(rist_for_jared,file = "data/sharing/rist_sc_temp_depth.csv" )



```

# Turb Threshold Exporting

```{r}
library(tidyverse)
library(ggplot2)
library(arrow)


all_data_15min <- read_feather(file = "data/pretty/all_data_15min.feather")

unique(all_data_15min$site)

archery <- filter(all_data_15min, site == "archery")
elc <- filter(all_data_15min, site == "elc")


ggplot(filter(all_data_15min, site %in% c("elc","timberline", "legacy")), aes(x = DT, y = Turbidity_NTU, color = site))+
  geom_line()

ggplot(elc, aes(x = DT, y = Turbidity_NTU))+
  geom_line()

timberline_turb <- filter(all_data_15min, site == "timberline"& Turbidity_NTU != "NaN")%>%
  select(DT, Turbidity_NTU)

write_csv_arrow(timberline_turb, sink = "data/sharing/threshold_calc/timberline_turb.csv")


get_turb <- function(site_name){
  turb <- filter(all_data_15min, site == site_name & Turbidity_NTU != "NaN")%>%
  select(DT, Turbidity_NTU)%>%
    mutate(datetime = str_sub(as.character(DT), end = -4))%>%
    select(datetime,Turbidity_NTU)
  
  write_csv_arrow(turb, sink = paste0("data/sharing/threshold_calc/",  site_name,  "_turb.csv"))
}

get_turb(site_name = "timberline")
get_turb(site_name = "elc")
get_turb(site_name = "archery")
get_turb(site_name = "legacy")


```

## Turbidity Thresholds Calculated:

```{r}
#Timberline: 427.7, 536.8
#Archery




```


