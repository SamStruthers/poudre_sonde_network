---
title: "2022 Report and Figures"
author: "Sam Struthers"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
source("src/package_loader.R")
lapply(c("tidyverse", "feather", "data.table", "ggpubr", "tidyr", "broom"), package_loader)

#walk(list.files('src/qaqc/explore_and_fix_fxns', pattern = "*.R", full.names = TRUE, recursive = TRUE), source)
# Source most recent flagging data
all_data_flagged <- readRDS("data/flagged/all_data_flagged.RDS") 
options(dplyr.summarise.inform = FALSE)
```


```{r}

calc_sum_stats <- function(site, parameter){
  
  site_stats <- all_data_flagged[[paste0(site, "-", parameter)]]%>%
    filter(is.na(cleaner_flag))%>%
    select(DT_round, mean)%>%
    summarize(
    min = min(mean, na.rm = TRUE),
    q1 = quantile(mean, 0.25, na.rm = TRUE),
    median = median(mean, na.rm = TRUE),
    q3 = quantile(mean, 0.75, na.rm = TRUE),
    max = max(mean, na.rm = TRUE)
  )%>%
    mutate(site = site, 
           parameter = parameter)
  return(site_stats)
} 

sites <- c("tamasag","legacy", "timberline", "prospect", "archery", "river bluffs")  
site_names <- tibble(site = c("tamasag", "legacy", "lincoln", "timberline", "prospect" ,"boxelder",  "archery", "river bluffs"), 
                        site_upper = c("Tamasag", "Legacy", "Lincoln", "Timberline", "Prospect" ,"Boxelder",  "Archery", "River Bluffs"))
params <- c("Temperature", "Specific Conductivity", "pH", "ORP", "DO", "Depth")

# Create all combinations of sites and params
combinations <- expand_grid(sites, params)

# Iterate over each combination using pmap_df
site_sum_stats <- pmap_df(combinations, ~calc_sum_stats(..1, ..2))
  
```


```{r}
color_code <- tibble(flag = c("missing data", "sonde not employed", 
                              "site visit", "sv window", 
                              "slope violation", "repeated value", 
                              "outside of seasonal range", "outside sd range", 
                              "outside of sensor specification range", "suspect data"),
                     color = c("grey", "black",
                               "#FFBA00", "#FFBA00",
                               "#002FA7", "#7DF365",
                               "#D55E00", "#1C7C54", 
                               "#FF69B4", "#bdcffc"))


color_joiner <-function(data, flag_type) {
  
  data %>%
    filter(grepl(flag_type, flag)) %>%
    mutate(flag = flag_type) %>%
    left_join(color_code, by = "flag")
  
}  

bg_colors <- c( "#01377D", "#009DD1", "#97E7F5", "#7ED348", "#26B170", "#000000")
or_colors <-c("#F5E15A", "#F4BE1D", "#FEA305", "#F26021", "#F34646")
```

```{r test vars}

sites = c("legacy", "timberline" ,"boxelder",  "archery", "river bluffs")
start_date = "2023-05-09 08:30:00"
end_date = "2023-05-16 09:30:00"
parameter = "Specific Conductivity"
title = "Sp. Conductivity"
units = "uS/cm"
hourly = TRUE

parameters <- c("Temperature", "Turbidity", "Specific Conductivity", "pH", "ORP", "DO", "Depth", "Battery Level", "Chl-a Fluorescence")
print(parameters)
```

# Plotter Function
```{r}


plotter <- function(clean = FALSE, hourly = TRUE, sites = c("legacy", "timberline" ,"boxelder",  "archery", "river bluffs"),
                           start_date = "2023-05-08 08:30:00", end_date = "2023-05-18 09:30:00", 
                           parameter = "Specific Conductivity", title = "Sp. Conductivity", units = "Sp. Conductivity (uS/cm) "){
  
  site_select_upper <- filter(site_names, site %in% sites)%>%pull(site_upper)
  site_select_join <- filter(site_names, site %in% sites)
  
  
  flag_start_date <- ymd_hms(start_date)
  flag_end_date <- ymd_hms(end_date)
  
  grab_site_data <- function(site){
    flag_plot_data <- all_data_flagged[[paste0(site, "-", parameter)]] %>% 
    filter(DT_round >= flag_start_date & DT_round <= flag_end_date)%>%
      #At a minimum remove site visits
    filter(!grepl("site visit", flag))
    
    # Ive found for storm events that flags remove valuable trends due to to their sharp increases in slope
    if(clean == TRUE){
   flag_plot_data <- flag_plot_data %>%
     filter(is.na(cleaner_flag))
    }
    if(hourly == TRUE){
    flag_plot_data <- flag_plot_data%>%
    group_by(DT_round = floor_date(DT_round, unit = "hour"),
             t_mean01, t_mean99) %>% 
    summarize(mean = median(mean, na.rm = TRUE)) %>% 
    ungroup()%>%
      mutate(site = site)
    }
    
  }
  
  all_flag_plot_data <- map(sites, grab_site_data)%>%
    bind_rows()%>%
    left_join(site_select_join, by  = "site")
    
  
  all_flag_plot_data$site_upper <- factor(all_flag_plot_data$site_upper, levels = site_select_upper)
  
  
  
  ggplot() +
    geom_line(data = all_flag_plot_data, 
               aes(x = DT_round, y = mean, color = site_upper), size = 2) +
    scale_color_manual(name = "Site", values = or_colors) +
    labs(x = "Date",
         y = paste(units)) +
    #ggtitle(paste(title)) +
    #ylim(y_min, y_max) +
    theme_classic(base_size = 28)
  
}

#plotter()

```

#Storms
## May rain storm
sites: Legacy, Timberline, Boxelder, Archery (maybe riverbluffs)
Params: Turbidity, Specific Conductivity, DO, Depth

```{r} 

#precip plot
may_precip <-read_csv("data/context_data/2023_report/utility_center_precip_may.csv")%>%
  rename(precip_accum_in = "PrecipAccum-Storm(6320)")%>%
  filter(DateTime >= ymd_hms("2023-05-08 08:30:00") & DateTime <= ymd_hms("2023-05-18 09:30:00"))%>%
  mutate(precip_accum_cm = precip_accum_in*2.54)

precip_plot <- ggplot(may_precip, aes(x= DateTime, y = precip_accum_cm))+
  geom_line(color = "#002FA7", linewidth = 2)+
  labs(
    x = "Date",
    y = "Precip. Accummulation (cm)"
  )+
  theme_classic(base_size = 28)+
  theme( legend.position = "none",
         axis.title.x  = element_blank(), 
         axis.title.y = element_text(size = 20,face = "bold") )
precip_plot
                           
may_sites <- c("legacy", "timberline", "boxelder", "archery")

#COND
clean_spec_cond_may <- plotter(sites = may_sites ,clean = FALSE)+ 
  theme(legend.position = "none", 
        axis.title.x=element_blank(),
        axis.title.y = element_text(size = 22,face = "bold"))
#Depth
clean_depth_may <- plotter(sites = may_sites, clean = TRUE, parameter = "Depth", units = "Depth (m)")+
  theme(legend.position = "none", 
        axis.title.x=element_blank(),
        axis.title.y = element_text(size = 22,face = "bold"))
#DO
clean_do_may <- plotter(sites = may_sites, clean = TRUE, parameter = "DO", units = "DO (mg/L)")+
  theme(legend.position = "none",
        axis.title.y = element_text(size = 22,face = "bold"))
#TURB
clean_temp_may <- plotter(sites = may_sites, clean = TRUE, parameter = "Temperature", units = "Temperature (C)")+
  theme(legend.position = "none",
        axis.title.y = element_text(size = 22,face = "bold"))


  ggarrange( precip_plot, precip_plot, clean_depth_may,clean_spec_cond_may,  clean_do_may , clean_temp_may, ncol = 2, nrow = 3, legend = "bottom", common.legend = T)

  ggsave("data/sharing/figures/2023/DRAFT_Red_urban_storm_may_2023.jpg",width = 20, height = 14, dpi = 300)
```

## July 31st storm

Sites: "tamasag","timberline", "prospect", "archery"
Params: Turb (Not at Archery ), Depth, Cond, DO

```{r}

july_sites <- c("tamasag", "legacy", "timberline", "prospect", "archery")
july_start_date <- "2023-07-28 12:00:00"
july_end_date <- "2023-08-08 12:00:00"
#COND
july_spec_cond <- plotter(sites = july_sites ,clean = FALSE, 
                          start_date = july_start_date, 
                          end_date = july_end_date)+ 
  theme(legend.position = "none", 
        axis.title.x=element_blank(),
        axis.title.y = element_text(size = 22,face = "bold"))

#Depth
july_depth <- plotter(sites = july_sites, clean = FALSE,
                        start_date = july_start_date, 
                          end_date = july_end_date, 
                      parameter = "Depth", units = "Depth (m)")+
  theme(legend.position = "none", 
        axis.title.x=element_blank(),
        axis.title.y = element_text(size = 22,face = "bold"))
#DO
july_do <- plotter(sites = july_sites, 
                         start_date = july_start_date, 
                          end_date = july_end_date, clean = FALSE, parameter = "DO", units = "DO (mg/L)")+
  theme(legend.position = "none",
        axis.title.y = element_text(size = 22,face = "bold"))
#TURB
july_turb <- plotter(sites = c("tamasag", "timberline", "prospect" ), clean = FALSE,
                     start_date = july_start_date, 
                          end_date = july_end_date, 
                     parameter = "Turbidity", units = "Turbidity (NTU)")+
  theme(legend.position = "none",
        axis.title.y = element_text(size = 22,face = "bold"))+
  scale_y_log10()




   ggarrange( july_depth,july_spec_cond,  july_do , july_turb, ncol = 2, nrow = 2, legend = "bottom", common.legend = T)
  # 
   #ggsave("data/sharing/figures/2023/DRAFT_urban_storm_july_2023.jpg",width = 20, height = 14, dpi = 300)

```

# September 4th Storm

```{r}
sept_sites <- c("tamasag", "legacy", "prospect", "archery")
sept_sites_turb <- c("tamasag", "legacy", "prospect")
sept_start_date <-  "2023-09-03 01:00:00"
sept_end_date <- "2023-09-07 12:00:00"


#COND
sept_spec_cond <- plotter(sites = sept_sites ,clean = FALSE, 
                          start_date = sept_start_date, 
                          end_date = sept_end_date)+ 
  theme(legend.position = "none", 
        
        axis.title.y = element_text(size = 22,face = "bold"))

#Depth
sept_depth <- plotter(sites = sept_sites, clean = FALSE,
                        start_date = sept_start_date, 
                          end_date = sept_end_date, 
                      parameter = "Depth", units = "Depth (m)")+
  theme(legend.position = "none", 
        axis.title.x=element_blank(),
        axis.title.y = element_text(size = 22,face = "bold"))
#DO
sept_do <- plotter(sites = sept_sites, 
                         start_date = sept_start_date, 
                          end_date = sept_end_date, clean = FALSE, parameter = "DO", units = "DO (mg/L)")+
  theme(legend.position = "none",
        axis.title.y = element_text(size = 22,face = "bold"))
#TURB
sept_turb <- plotter(sites = sept_sites_turb, clean = FALSE,
                     start_date = sept_start_date, 
                          end_date = sept_end_date, 
                     parameter = "Turbidity", units = "Turbidity (NTU)")+
  theme(legend.position = "none",
        axis.title.x=element_blank(),
        axis.title.y = element_text(size = 22,face = "bold"))

#Temp
sept_temp <- plotter(sites = sept_sites, clean = FALSE,
                     start_date = sept_start_date, 
                          end_date = sept_end_date, 
                     parameter = "Temperature", units = "Temperature (C)")+
  theme(legend.position = "none",
        axis.title.y = element_text(size = 22,face = "bold"))
#pH
sept_ph<- plotter(sites = sept_sites, clean = TRUE,
                     start_date = sept_start_date, 
                          end_date = sept_end_date, 
                     parameter = "pH", units = "pH")+
  theme(legend.position = "none",
        axis.title.y = element_text(size = 22,face = "bold"))

ggarrange( sept_depth, sept_turb,sept_spec_cond, sept_do ,   ncol = 2, nrow = 2, legend = "bottom", common.legend = T)

ggsave("data/sharing/figures/2023/DRAFT_blackwater_sept_2023.jpg",width = 20, height = 14, dpi = 300)


```




# Reservoir Releases

## Fossil Creek release (Nov 10th)
NOT YET IN DATASET
Sites: "archery", "river bluffs"
Params: pH, Depth, Temp, Chl-a

```{r}
foscrk_sites <- c("archery", "river bluffs")
foscrk_start_date <- "2023-11-05 12:00:00"
foscrk_end_date <- "2023-11-12 12:00:00"

#Depth
foscrk_depth <- plotter(sites = foscrk_sites, clean = FALSE,
                          start_date = foscrk_start_date, 
                          end_date = foscrk_end_date, 
                      parameter = "Depth", units = "Depth (m)")+
  theme(legend.position = "none", 
        axis.title.x=element_blank(),
        axis.title.y = element_text(size = 22,face = "bold"))
```

# Reservoir Releases

## Horsetooh release (Oct 15- Nov 2)
Sites: "tamasag", "lincoln","prospect", "archery", "river bluffs"
Params: pH, Depth, Temp, Chl-a

```{r}

horse_sites <- c("tamasag", "lincoln","prospect", "archery", "river bluffs")
horse_start_date <- "2023-10-18 12:00:00"
horse_end_date <- "2023-10-26 12:00:00"

#Depth
horse_depth <- plotter(clean = TRUE, sites = horse_sites, 
                       start_date = horse_start_date, end_date = horse_end_date, 
                       parameter = "Depth", units = "Depth (m)")+
  theme(legend.position = "none", 
        axis.title.x=element_blank(),
        axis.title.y = element_text(size = 22,face = "bold"))
#pH
horse_ph<- plotter(clean = TRUE, sites = horse_sites, 
                       start_date = horse_start_date, end_date = horse_end_date, 
                       parameter = "pH", units = "pH")+
  theme(legend.position = "none", 
        axis.title.x=element_blank(),
        axis.title.y = element_text(size = 22,face = "bold"))
#Temp
horse_temp <- plotter(clean = FALSE, sites = horse_sites, 
                       start_date = horse_start_date, end_date = horse_end_date, 
                       parameter = "Temperature", units = "Temperature (C)")+
  theme(legend.position = "none", 
        axis.title.x=element_blank(),
        axis.title.y = element_text(size = 22,face = "bold"))
#Cond
horse_cond <- plotter(clean = TRUE, sites = horse_sites, 
                       start_date = horse_start_date, end_date = horse_end_date)+
  theme(legend.position = "none", 
        axis.title.x=element_blank(),
        axis.title.y = element_text(size = 22,face = "bold"))
#DO
horse_DO <- plotter(clean = FALSE, sites = horse_sites, 
                       start_date = horse_start_date, end_date = horse_end_date,
                       parameter = "DO", units = "DO (mg/L)")+
  theme(legend.position = "none", 
        axis.title.x=element_blank(),
        axis.title.y = element_text(size = 22,face = "bold"))
# #turbidity
# horse_turb <- plotter(clean = TRUE, sites = c("legacy", "lincoln","prospect"), 
#                        start_date = horse_start_date, end_date = horse_end_date,
#                        parameter = "Turbidity", units = "Turbidity (NTU)")+
#   theme(legend.position = "none", 
#         axis.title.x=element_blank(),
#         axis.title.y = element_text(size = 22,face = "bold"))

ggarrange(horse_depth, horse_DO,horse_cond,  horse_temp, ncol = 2, nrow = 2, legend = "bottom", common.legend = T)
ggsave("data/sharing/figures/2023/DRAFT_BG_horsetooth_release_oct.jpg",width = 20, height = 14, dpi = 300)

```





