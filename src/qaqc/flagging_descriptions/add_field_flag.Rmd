---
title: "Add Field Note Flags"
author: "ROSSyndicate"
date: "`r Sys.Date()`"
output: 
  html_document:
    number_sections: true
    toc: true
    toc_float: true
editor_options: 
  markdown: 
    wrap: 90
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, error = FALSE, message = FALSE) 
```

```{r, include=FALSE}
source("src/package_loader.R")
lapply(c("data.table", "tidyverse", "kableExtra"), package_loader)
```

# `add_field_flag()`

This function adds three flags:

1. `"sonde not employed"`
2. `"site visit"`
3. `"sv window"`

These flags are determined using the field notes that staff take when they are servicing the sondes. 

```{r}
add_field_flag <- function(df) {
  df <- df %>%
    # flag when sonde was not employed in the river
    add_flag(sonde_employed == 1, "sonde not employed") %>%
    # flag when sonde was handled in a site visit
    add_flag(as.character(last_site_visit) == as.character(DT_round), "site visit") %>%
    # Add flags for the next 45 minutes after a site visit
    add_flag(lag(str_detect(flag, "site visit"), n = 3), "sv window") %>%
    add_flag(lag(str_detect(flag, "site visit"), n = 2), "sv window") %>%
    add_flag(lag(str_detect(flag, "site visit"), n = 1), "sv window")
  return(df)
}
```

## Add `"sonde not employed"` flag.
**The sonde not employed flag is triggered when the `sonde_employed` column is equal to one. The `sonde_employed` column is generated in the `clean_field_notes` function and uses the `sensor_pulled` and `sensor_deployed` columns from the original field notes**
```{r}
add_flag(sonde_employed == 1,
         "sonde not employed") 
```
- `sonde_employed` = Binary result from the `clean_field_notes()` step in the pipeline.
- `"sonde not employed"` = Flag descriptor inserted into the `flag` column.

## Add `"site visit"` flag.
**The site visit flag is triggered when the `last_site_visit` column is equal to the `DT_round` column
