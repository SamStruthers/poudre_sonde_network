---
title: "Organizing raw data"
author: "Katie Willi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Merge the datasets from all API pulls:
```{r}
all_data <- list.files(path = 'data/api/', full.names = TRUE) %>%
  map(~read_csv(.)) %>%
  bind_rows() %>%
  # remove overlapping API-pull data
  distinct()
```

Load and munge field calibration files:
```{r}
cal_files <- list.files("data/calibration_reports", pattern=".html")

cal_tabler <- function(cal_files){
  
  cal <- read_html(file.path("data/calibration_reports/", cal_files)) %>%
    html_nodes('div') %>%
    html_text() %>%
    as_tibble()
  
  rdo <- cal %>% filter(grepl("RDO", value)) %>% pull() %>% str_replace_all(., " ", "")
  
  ph_orp <- cal %>% filter(grepl("pH/ORP", value)) %>% pull() %>% str_replace_all(., " ", "")
  
  conductivity <- cal %>% filter(grepl("Conductivity",value)) %>% pull() %>% str_replace_all(., " ", "")
  
  turbidity <- cal %>% filter(grepl("Turbidity",value)) %>% pull() %>% str_replace_all(., " ", "")
  
  time_mst <- paste0(str_sub(cal_files, -13, -12),":", str_sub(cal_files, -11, -10))
  
  date <- paste0(str_sub(cal_files, -22, -19),"-", str_sub(cal_files, -18, -17),"-", str_sub(cal_files, -16, -15))
  
  cal_table <- tibble(site = sub("\\_.*", "", cal_files),
                      
                      DT = ymd_hm(paste(date, time_mst, tz = "MST")),
                      
                      #Dissolved Oxygen
                      rdo_slope = str_match(rdo, "Slope\\s*(.*?)\\s*Offset")[,2],
                      rdo_offset = str_match(rdo, "Offset\\s*(.*?)\\s*mg/L")[,2],
                      rdo_100 = str_match(rdo, "PreMeasurement\\s*(.*?)\\s*%SatPost")[,2],
                      rdo_conc = str_match(rdo, "Concentration\\s*(.*?)\\s*mg/LPreMeasurement")[,2],
                      rdo_temp = str_match(rdo, "Temperature\\s*(.*?)\\s*°C")[,2],
                      rdo_pressure = str_match(rdo, "Pressure\\s*(.*?)\\s*mbar")[,2],
                      
                      #pH
                      ph_slope_pre = str_match(ph_orp, "Offset1Slope\\s*(.*?)\\s*mV/pH")[,2],
                      ph_offset_pre = str_match(ph_orp, "mV/pHOffset\\s*(.*?)\\s*mVSlopeandOffset2")[,2],
                      ph_slope_post = str_match(ph_orp, "Offset2Slope\\s*(.*?)\\s*mV/pH")[,2],
                      ph_offset_post = str_match(ph_orp, paste0(ph_slope_post,"mV/pHOffset\\s*(.*?)\\s*mVORPORP"))[,2],
                      ph_7_nice = str_sub(str_match(ph_orp, "PostMeasurementpH7\\s*(.*?)\\s*mVCal")[,2], 10, nchar(str_match(ph_orp, "PostMeasurementpH7\\s*(.*?)\\s*mVCal")[,2])),
                      ph_7_other = str_sub(str_match(ph_orp, "PostMeasurementpH6\\s*(.*?)\\s*mVCal")[,2], 10, nchar(str_match(ph_orp, "PostMeasurementpH6\\s*(.*?)\\s*mVCal")[,2])),
                      ph_7 = ifelse(is.na(ph_7_nice), ph_7_other, ph_7_nice),
                      
                      #ORP
                                             orp_offset = ifelse(is.na(str_match(tolower(ph_orp), "zobell'soffset\\s*(.*?)\\s*mvtemperature")[,2]),
                                           str_match(ph_orp, "ORPStandardOffset\\s*(.*?)\\s*mVTemperature")[,2],
                                           str_match(tolower(ph_orp), "zobell'soffset\\s*(.*?)\\s*mvtemperature")[,2]),
                      
                      #Conductivity
                      tds_conversion_ppm = str_sub(str_match(conductivity, "TDSConversionFactor\\s*(.*?)\\s*CellConstant")[,2], 6, nchar(str_match(conductivity, "TDSConversionFactor\\s*(.*?)\\s*CellConstant")[,2])),
                      cond_cell_constant = str_match(conductivity, "CellConstant\\s*(.*?)\\s*ReferenceTemperature")[,2],
                      cond_pre = str_match(conductivity,paste0(str_match(conductivity,
                                                                         "PreMeasurementActual\\s*(.*?)\\s*SpecificConductivity")[,2],"SpecificConductivity\\s*(.*?)\\s*µS/cmPost"))[,2],
                      cond_post = str_match(conductivity,paste0(str_match(conductivity,
                                                                          "PostMeasurementActual\\s*(.*?)\\s*SpecificConductivity")[,2],"SpecificConductivity\\s*(.*?)\\s*µS/cm"))[,2],
                      
                      #Turbidity
                      ntu_slope = "None",
                      ntu_offset = "None",
                      ntu_10 = "None",
                      ntu_100 = "None") %>%
    
  select(-c(ph_7_nice, ph_7_other))
  
  try(cal_table <- cal_table %>%
        mutate(     
          #Turbidity
          ntu_slope = str_match(turbidity, "Slope\\s*(.*?)\\s*Offset")[,2],
          ntu_offset = str_match(turbidity, "Offset\\s*(.*?)\\s*NTU")[,2],
          ntu_10 = str_match(turbidity, "CalibrationPoint1PreMeasurement\\s*(.*?)\\s*NTUPost")[,2],
          ntu_100 = str_match(turbidity, "CalibrationPoint2PreMeasurement\\s*(.*?)\\s*NTUPost")[,2]))
  
  cal_table <- cal_table %>%
    mutate(
      #Factory Defaults
      factory_defaults = paste0(ifelse(is.na(ntu_slope), "Turbidity ", ""),
                                ifelse(is.na(rdo_slope), "RDO ", ""),
                                ifelse(is.na(ph_slope_post), "pH ", ""),
                                ifelse(is.na(orp_offset), "ORP ", ""),
                                ifelse(is.na(cond_post), "Conductivity ", "")))

cal_table
  
}

cal_table <- map_dfr(cal_files, cal_tabler) %>%
  distinct(.keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(DT = round_date(DT, "15 minutes"))
```

Load field notes:
```{r}
field_notes <- readxl::read_excel('data/sensor_field_notes.xlsx') %>%
  mutate(DT = (paste0(date, " ", start_time_mst))) %>%
  mutate(DT = ymd_hm(DT)) %>%
  arrange(DT) %>%
  mutate(DT = round_date(DT, "15 minutes"))
```


